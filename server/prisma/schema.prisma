// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

// ==============================================
// Chatforia Prisma Schema (organized by domains)
// ==============================================
//
// Order rationale (high-level):
// 0) Generator/Datasource
// 1) Enums
// 2) Core Identity & Access (User + auth + devices + social)
// 3) Config & Localization (language/i18n + region + pricing)
// 4) Family / Purchases / Provisioning
// 5) Conversations (rooms + membership)
// 6) Messaging (messages + E2EE + media + scheduling + uploads + SMS)
// 7) Contacts / Moderation / Support / Auditing
// 8) Status / Stories
// 9) Bots & Automation
// 10) Telecom (calls, numbers, voicemail, porting)
// 11) Accessibility / Usage (transcripts, STT usage)
//
// NOTE: Keep generator/datasource matching your project.
// ----------------------------------------------

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===================== 1) Global Enums =====================

enum Plan {
  FREE
  PLUS
  PREMIUM
  WIRELESS
}

enum RoomRole {
  MEMBER
  MODERATOR
  ADMIN
}

enum AttachmentKind {
  IMAGE
  VIDEO
  AUDIO
  FILE
  STICKER
  GIF
}

enum StatusAudience {
  EVERYONE
  CONTACTS
  MUTUALS
  CUSTOM
}

enum StatusAssetKind {
  IMAGE
  VIDEO
  AUDIO
  GIF
  STICKER
  FILE
}

enum AutoResponderMode {
  OFF
  DM
  MENTION
  ALL
}

enum AutoTranslateMode {
  OFF
  TAGGED
  ALL
}

enum AIAssistantMode {
  OFF
  MENTION
  ALWAYS
}

enum AgeBand {
  TEEN_13_17
  ADULT_18_24
  ADULT_25_34
  ADULT_35_49
  ADULT_50_PLUS
}

enum ContentScope {
  COMMANDS
  MENTIONS
  ALL
}

enum CallMode {
  AUDIO
  VIDEO
}

enum CallStatus {
  INITIATED
  RINGING
  ANSWERED
  REJECTED
  MISSED
  CANCELLED
  ENDED
}

enum NumberStatus {
  AVAILABLE
  RESERVED
  ASSIGNED
  HOLD
  RELEASING
  RELEASED
}

enum PortStatus {
  NONE
  PORT_IN_PENDING
  PORTED_IN
  PORT_OUT_PENDING
  PORTED_OUT
}

enum PhoneNumberSource {
  PROVISIONED
  PORTED
}

enum A11YFont {
  sm
  md
  lg
  xl
}

enum A11YBg {
  light
  dark
  transparent
}

enum RegionTier {
  T1
  T2
  T3
  T4
  ROW // Rest of World (fallback)
}

enum FamilyRole {
  OWNER
  MEMBER
}

enum FamilyInviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

enum SubscriberStatus {
  PENDING
  PROVISIONING
  ACTIVE
  SUSPENDED
  CANCELLED
  PORTING
}

enum VerificationType {
  EMAIL
  PHONE
  MFA_LOGIN
}

enum VoicemailTranscriptStatus {
  PENDING
  COMPLETE
  FAILED
}

// ===================== 2) Core Identity & Access =====================

model User {
  id                   Int     @id @default(autoincrement())
  username             String  @unique
  email                String? @unique
  password             String
  phoneNumber          String? @db.VarChar(32)
  preferredLanguage    String  @default("en")
  allowExplicitContent Boolean @default(false)

  // NOTE: existing field uses "...WithTranslation"
  showOriginalWithTranslation Boolean @default(true)

  role               String  @default("USER")
  enableAIResponder  Boolean @default(false)
  enableSmartReplies Boolean @default(false)

  // palette/theme family key (e.g., "dawn" | "midnight" | "amoled" ...)
  theme String @default("dawn")

  // global auto-translate toggle
  autoTranslate Boolean @default(true)

  forwardingEnabledSms   Boolean @default(false)
  forwardSmsToPhone      Boolean @default(false)
  forwardPhoneNumber     String? @db.VarChar(32)
  forwardSmsToEmail      Boolean @default(false)
  forwardEmail           String? @db.VarChar(255)
  forwardingEnabledCalls Boolean @default(false)
  forwardToPhoneE164     String? @db.VarChar(32)
  forwardQuietHoursStart Int?
  forwardQuietHoursEnd   Int?

  cycling    Boolean     @default(false)
  strictE2EE Boolean     @default(false)
  uploads    Upload[]    @relation("UserUploads")
  smsThreads SmsThread[] @relation("UserSmsThreads")

  // --- verification & 2FA ---
  emailVerifiedAt        DateTime?
  tokenVersion           Int      @default(0)
  emailVerifiedIp        String?
  phoneVerifiedAt        DateTime?
  phoneVerifiedIp        String?
  twoFactorEnabled       Boolean                 @default(false)
  totpSecretEnc          String?
  twoFactorEnrolledAt    DateTime?
  verificationTokens     VerificationToken[]
  twoFactorRecoveryCodes TwoFactorRecoveryCode[]
  phones                 Phone[]

  autoResponderMode        AutoResponderMode @default(DM)
  autoResponderCooldownSec Int               @default(120)
  autoResponderActiveUntil DateTime?
  autoResponderSignature   String?

  // ---------- Billing ----------
  stripeCustomerId     String? @unique
  stripeSubscriptionId String?

  // Regional pricing (added)
  pricingRegion  RegionTier?
  billingCountry String?     @db.VarChar(2)
  currency       String?     @db.VarChar(8)
  firstPaidAt    DateTime?

  esimIccid String? @map("tealIccid") @db.VarChar(64)

  publicKey String?

  // Relations
  followers                  Follow[]             @relation("follower")
  following                  Follow[]             @relation("following")
  passwordResetTokens        PasswordResetToken[] @relation("UserPasswordResetTokens")
  roomsOwned                 ChatRoom[]           @relation("ChatRoomOwner")
  messages                   Message[]            @relation("UserMessages")
  messageReads               MessageRead[]
  participants               Participant[]
  reports                    Report[]             @relation("UserReports")
  randomChatRooms            RandomChatRoom[]     @relation("RandomChatParticipants")
  readMessages               Message[]            @relation("ReadMessages")
  contactsOwned              Contact[]            @relation("ContactsOwned")
  contactsSaved              Contact[]            @relation("ContactsSaved")
  auditLogs                  AuditLog[]           @relation("AuditActor")
  messageKeys                MessageKey[]
  messageDeletions           MessageDeletion[]
  devices                    Device[]
  deviceRevocations          Device[]             @relation("DeviceRevokedBy")
  createdInvites             ChatRoomInvite[]     @relation("InviteCreator")
  messageReactions           MessageReaction[]
  statusesAuthored           Status[]
  statusKeys                 StatusKey[]
  statusViews                StatusView[]
  statusReactions            StatusReaction[]
  botsOwned                  Bot[]                @relation("BotsOwned")
  botsAsService              Bot[]                @relation("BotServiceUser")
  provisionLinks             ProvisionLink[]      @relation("ProvisionLinkUser")
  provisionLinksCreated      ProvisionLink[]      @relation("ProvisionLinkCreator")
  callsPlaced                Call[]               @relation("CallCaller")
  callsReceived              Call[]               @relation("CallCallee")
  scheduledMessagesAuthored  ScheduledMessage[]   @relation("ScheduledMessageSender")
  messageSessionKeysReceived MessageSessionKey[]  @relation("MsgSessionKeys_Recipient")
  assignedNumbers            PhoneNumber[]
  numberReservations         NumberReservation[]  @relation("UserNumberReservations")
  transcripts                Transcript[]
  foriaRemember              Boolean              @default(true)
  foriaMessages              ForiaMessage[]

  familyMemberships FamilyMember[]
  familiesOwned     FamilyGroup[]  @relation("FamilyOwner")

  mobileDataPackPurchases MobileDataPackPurchase[]

  portRequests PortRequest[]

  // Usage/analytics
  sttUsage STTUsage[] @relation("UserSTTUsage")

  // Settings
  plan              Plan    @default(FREE)
  autoDeleteSeconds Int?
  showReadReceipts  Boolean @default(true)
  avatarUrl         String?
  emojiTag          String?
  messageTone       String? @default("default.mp3")
  ringtone          String? @default("classic.mp3")

  voicemailEnabled        Boolean @default(true)
  voicemailAutoDeleteDays Int?

  voicemailGreetingUrl  String?
  voicemailGreetingText String?
  voicemailForwardEmail String?

  voicemails Voicemail[]

  privacyBlurEnabled   Boolean @default(false)
  privacyBlurOnUnfocus Boolean @default(false)
  privacyHoldToReveal  Boolean @default(false)
  notifyOnCopy         Boolean @default(false)

  ageBand                AgeBand?
  ageAttestedAt          DateTime?
  wantsAgeFilter         Boolean   @default(true)
  randomChatAllowedBands Json?

  // Accessibility preferences...
  a11yUiFont                  String  @default("md")
  a11yVisualAlerts            Boolean @default(false)
  a11yVibrate                 Boolean @default(false)
  a11yFlashOnCall             Boolean @default(false)
  a11yLiveCaptions            Boolean @default(false)
  a11yVoiceNoteSTT            Boolean @default(false)
  a11yCaptionFont             String  @default("lg")
  a11yCaptionBg               String  @default("dark")
  a11yStoreTranscripts        Boolean @default(true)
  a11yTranscriptRetentionDays Int?
  a11yCaptionPosition         String  @default("bottom")
  a11yCaptionMaxLines         Int     @default(3)
}

model VerificationToken {
  id        Int       @id @default(autoincrement())
  userId    Int
  type      String
  tokenHash String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, type])
  @@index([expiresAt])
}

model TwoFactorRecoveryCode {
  id        Int       @id @default(autoincrement())
  userId    Int
  codeHash  String
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model PasswordResetToken {
  id        Int       @id @default(autoincrement())
  userId    Int
  user      User      @relation("UserPasswordResetTokens", fields: [userId], references: [id], onDelete: Cascade)
  tokenHash String    @db.VarChar(64)
  expiresAt DateTime
  usedAt    DateTime?

  @@index([tokenHash])
  @@index([userId, usedAt])
  @@index([expiresAt])
}

model Follow {
  id          Int      @id @default(autoincrement())
  follower    User     @relation("follower", fields: [followerId], references: [id])
  followerId  Int
  following   User     @relation("following", fields: [followingId], references: [id])
  followingId Int
  createdAt   DateTime @default(now())

  @@unique([followerId, followingId])
  @@index([followingId])
}

model Device {
  id String @id @default(cuid())

  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  publicKey  String
  name       String?
  platform   String?
  isPrimary  Boolean   @default(false)
  createdAt  DateTime  @default(now())
  lastSeenAt DateTime?
  revokedAt  DateTime?

  revokedById Int?
  revokedBy   User? @relation("DeviceRevokedBy", fields: [revokedById], references: [id])

  messageSessionKeys MessageSessionKey[] @relation("MsgSessionKeys_Device")

  @@index([userId])
}

// ===================== 3) Config & Localization =====================

model Language {
  id          Int      @id @default(autoincrement())
  code        String   @unique // e.g. 'en', 'es'
  displayName String // e.g. 'English', 'Español'
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Translation {
  id        Int      @id @default(autoincrement())
  language  String
  key       String
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([language, key])
}

model RegionRule {
  id          String     @id @default(cuid())
  countryCode String     @db.VarChar(2) // ISO 3166-1 alpha-2 (e.g., "US")
  tier        RegionTier

  @@unique([countryCode])
}

model Price {
  id            String     @id @default(cuid())
  product       String     @db.VarChar(64) // e.g., "chatforia_premium"
  tier          RegionTier
  currency      String     @db.VarChar(8) // e.g., "USD", "INR"
  unitAmount    Int // minor units (e.g., $9.99 => 999)
  stripePriceId String?    @unique
  appleSku      String? // App Store product ID per storefront (optional)
  googleSku     String? // Play Store product ID (optional)
  active        Boolean    @default(true)

  @@unique([product, tier, currency])
  @@index([product, tier, currency])
}

model PriceOverride {
  id            String   @id @default(cuid())
  countryCode   String
  plan          Plan
  currency      String
  priceCents    Int
  stripePriceId String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// ===================== 4) Family / Purchases / Provisioning =====================

model FamilyGroup {
  id          Int    @id @default(autoincrement())
  ownerId     Int
  owner       User   @relation("FamilyOwner", fields: [ownerId], references: [id])
  name        String @default("My Chatforia Family")
  totalDataMb Int    @default(0)
  usedDataMb  Int    @default(0)

  members FamilyMember[]
  invites FamilyInvite[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model FamilyMember {
  id          Int         @id @default(autoincrement())
  groupId     Int
  userId      Int
  group       FamilyGroup @relation(fields: [groupId], references: [id])
  user        User        @relation(fields: [userId], references: [id])
  role        FamilyRole  @default(MEMBER)
  limitDataMb Int?
  usedDataMb  Int         @default(0)
  createdAt   DateTime    @default(now())
}

model FamilyInvite {
  id         Int                @id @default(autoincrement())
  groupId    Int
  group      FamilyGroup        @relation(fields: [groupId], references: [id])
  email      String?
  phone      String?
  token      String             @unique
  status     FamilyInviteStatus @default(PENDING)
  expiresAt  DateTime?
  acceptedAt DateTime?
  createdAt  DateTime           @default(now())
}

model MobileDataPackPurchase {
  id     Int  @id @default(autoincrement())
  userId Int
  user   User @relation(fields: [userId], references: [id])

  kind      String // "ESIM" | "FAMILY"
  addonKind String // "ESIM_STARTER" | "FAMILY_SMALL" etc.

  purchasedAt DateTime  @default(now())
  expiresAt   DateTime?

  totalDataMb     Int
  remainingDataMb Int

  stripeCheckoutSessionId String? @db.Text
  stripePaymentIntentId   String? @db.Text

  /// ICCID for the carrier line (legacy column tealIccid)
  esimIccid String? @map("tealIccid")

  /// Carrier profile id (legacy column tealProfileId)
  esimProfileId String? @map("tealProfileId")

  qrCodeSvg         String?
  provisioningError String?
}

model ProvisionLink {
  id String @id @default(cuid())

  userId Int
  user   User @relation("ProvisionLinkUser", fields: [userId], references: [id], onDelete: Cascade)

  createdById Int?
  createdBy   User? @relation("ProvisionLinkCreator", fields: [createdById], references: [id], onDelete: SetNull)

  secret    String
  expiresAt DateTime
  usedAt    DateTime?
  sasCode   String
  createdAt DateTime  @default(now())

  @@index([userId])
}

// ===================== 5) Conversations & Participation =====================

model ChatRoom {
  id              Int             @id @default(autoincrement())
  name            String?
  aiAssistantMode AIAssistantMode @default(OFF)
  isGroup         Boolean         @default(false)
  ownerId         Int?
  owner           User?           @relation("ChatRoomOwner", fields: [ownerId], references: [id])
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  participants Participant[]
  messages     Message[]     @relation("ChatRoomMessages")

  autoTranslateMode AutoTranslateMode @default(OFF)
  allowForiaBot     Boolean           @default(false)

  invites           ChatRoomInvite[]   @relation("RoomInvites")
  botInstalls       BotInstall[]       @relation("BotInstallRoom")
  scheduledMessages ScheduledMessage[] @relation("ScheduledMessageRoom")

  @@index([ownerId])
  @@index([updatedAt, id], map: "room_updated_id")
}

model Participant {
  id         Int @id @default(autoincrement())
  userId     Int
  chatRoomId Int

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  chatRoom ChatRoom @relation(fields: [chatRoomId], references: [id], onDelete: Cascade)

  role       RoomRole @default(MEMBER)
  joinedAt   DateTime @default(now())
  allowAIBot Boolean  @default(true)

  archivedAt DateTime?

  clearedAt DateTime?

  @@unique([chatRoomId, userId])
  @@index([chatRoomId], map: "part_room")
  @@index([userId, clearedAt], map: "part_user_cleared") // optional but helpful
}

model ChatRoomInvite {
  id   Int    @id @default(autoincrement())
  code String @unique

  chatRoomId Int
  chatRoom   ChatRoom @relation("RoomInvites", fields: [chatRoomId], references: [id], onDelete: Cascade)

  createdById Int
  createdBy   User @relation("InviteCreator", fields: [createdById], references: [id], onDelete: Cascade)

  maxUses   Int       @default(0)
  uses      Int       @default(0)
  expiresAt DateTime?
  createdAt DateTime  @default(now())
}

model RandomChatRoom {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())

  participants User[]    @relation("RandomChatParticipants")
  messages     Message[]
  aiEnabled    Boolean   @default(false)
}

// ===================== 6) Messaging (Messages + E2EE + Media + Scheduling) =====================

model Message {
  id                Int       @id @default(autoincrement())
  clientMessageId   String?
  contentCiphertext Json?
  rawContent        String?
  translations      Json?
  translatedFrom    String?
  translatedContent String?
  translatedTo      String?
  isExplicit        Boolean   @default(false)
  imageUrl          String?
  audioUrl          String?
  audioDurationSec  Int?
  expiresAt         DateTime?
  editedAt          DateTime?
  revision          Int       @default(1)

  deletedBySender Boolean   @default(false)
  deletedAt       DateTime?
  deletedForAll   Boolean   @default(false)
  deletedById     Int? // who triggered delete-for-everyone (sender/admin)

  senderId   Int
  chatRoomId Int

  sender   User     @relation("UserMessages", fields: [senderId], references: [id], onDelete: Cascade)
  chatRoom ChatRoom @relation("ChatRoomMessages", fields: [chatRoomId], references: [id], onDelete: Cascade)

  keys        MessageKey[]
  attachments MessageAttachment[]
  reactions   MessageReaction[]
  reports     Report[]

  randomChatRoomId Int?
  randomChatRoom   RandomChatRoom? @relation(fields: [randomChatRoomId], references: [id])

  createdAt   DateTime @default(now())
  readBy      User[]   @relation("ReadMessages")
  isAutoReply Boolean  @default(false)

  sessionKeys MessageSessionKey[] @relation("MsgSessionKeys_Message")

  deletions MessageDeletion[]

  // relations
  reads MessageRead[]

  @@unique([chatRoomId, senderId, clientMessageId], map: "msg_client_idempotency")
  @@index([expiresAt])
  @@index([chatRoomId, id], map: "msg_room_id")
  @@index([chatRoomId, createdAt], map: "msg_room_time")
  @@index([chatRoomId, createdAt, id], map: "msg_room_time_id")
  @@index([deletedForAll, expiresAt], map: "msg_deleted_expires_idx")
}

model MessageRead {
  messageId Int
  userId    Int
  readAt    DateTime @default(now())

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([messageId, userId])
  @@index([userId, readAt])
  @@index([messageId])
}

model MessageKey {
  messageId    Int
  userId       Int
  encryptedKey String

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([messageId, userId])
  @@index([userId])
}

model MessageSessionKey {
  id String @id @default(cuid())

  messageId         Int
  recipientUserId   Int
  recipientDeviceId String

  message         Message @relation("MsgSessionKeys_Message", fields: [messageId], references: [id], onDelete: Cascade)
  recipientUser   User    @relation("MsgSessionKeys_Recipient", fields: [recipientUserId], references: [id], onDelete: Cascade)
  recipientDevice Device  @relation("MsgSessionKeys_Device", fields: [recipientDeviceId], references: [id], onDelete: Cascade)

  encryptedSessionKey String

  @@index([messageId, recipientUserId])
  @@index([recipientUserId])
  @@index([recipientDeviceId])
}

model MessageDeletion {
  id        Int      @id @default(autoincrement())
  messageId Int
  userId    Int
  createdAt DateTime @default(now())

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@index([userId])
  @@index([messageId])
}

model MessageAttachment {
  id          Int            @id @default(autoincrement())
  messageId   Int
  kind        AttachmentKind
  url         String
  mimeType    String
  width       Int?
  height      Int?
  durationSec Int?
  caption     String?
  thumbUrl    String?
  fileSize    Int? // bytes
  waveform    Json? // e.g., 64-sample array for visualizer
  createdAt   DateTime       @default(now())

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

  deletedAt   DateTime?
  @@index([deletedAt])
  @@index([messageId])
  @@index([kind, messageId]) // quick media queries per message
}

model MessageReaction {
  messageId Int
  userId    Int
  emoji     String
  createdAt DateTime @default(now())

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([messageId, userId, emoji])
  @@index([messageId])
  @@index([userId])
}

model ScheduledMessage {
  id          Int      @id @default(autoincrement())
  chatRoomId  Int
  senderId    Int
  content     String
  scheduledAt DateTime
  createdAt   DateTime @default(now())

  chatRoom ChatRoom @relation("ScheduledMessageRoom", fields: [chatRoomId], references: [id], onDelete: Cascade)
  sender   User     @relation("ScheduledMessageSender", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([chatRoomId])
  @@index([senderId])
  @@index([scheduledAt])
}

// Uploads (media storage metadata)
model Upload {
  id           Int      @id @default(autoincrement())
  ownerId      Int
  key          String
  sha256       String   @db.VarChar(64)
  originalName String
  mimeType     String
  size         Int
  driver       String // 'local' | 's3'
  createdAt    DateTime @default(now())

  owner User @relation("UserUploads", fields: [ownerId], references: [id], onDelete: Cascade)

  // choose ONE of these uniqueness guarantees:
  // key is globally unique:
  // @unique on key:
  // key String @unique
  //
  // OR key is unique per owner:
  // @@unique([ownerId, key])

  @@index([ownerId])
  @@index([sha256])
}

model SmsThread {
  id           Int       @id @default(autoincrement())
  contactId    Int?
  contact      Contact?  @relation(fields: [contactId], references: [id])
  userId       Int
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  archivedAt   DateTime?
  contactPhone String?   @db.VarChar(32)

  participants SmsParticipant[]
  messages     SmsMessage[]

  user User @relation("UserSmsThreads", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model SmsMessage {
  id                Int       @id @default(autoincrement())
  threadId          Int
  direction         String // 'in' | 'out'
  fromNumber        String    @db.VarChar(32)
  toNumber          String    @db.VarChar(32)
  body              String
  provider          String?
  providerMessageId String?   @db.VarChar(128)
  mediaUrls         Json?
  createdAt         DateTime  @default(now())
  editedAt          DateTime?

  // link to thread (existing)
  thread SmsThread @relation(fields: [threadId], references: [id])

  // optional FK to Phone (helps joins & enforces integrity)
  phoneId Int?
  phone   Phone? @relation(fields: [phoneId], references: [id])

  @@index([threadId])
  @@index([providerMessageId])
  @@index([phoneId, createdAt])
}

model SmsParticipant {
  id        Int      @id @default(autoincrement())
  threadId  Int
  phone     String   @db.VarChar(32) // E.164
  createdAt DateTime @default(now())

  thread SmsThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@unique([threadId, phone])
  @@index([phone])
}

model ThreadClear {
  id         Int      @id @default(autoincrement())
  userId     Int
  chatRoomId Int
  clearedAt  DateTime @default(now())

  @@unique([userId, chatRoomId])
  @@index([chatRoomId])
}

// ===================== 7) Contacts / Moderation / Support / Auditing =====================

model Contact {
  id            Int         @id @default(autoincrement())
  ownerId       Int
  userId        Int?
  externalPhone String? // normalized digits with optional +
  externalName  String?
  alias         String?
  favorite      Boolean     @default(false)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  smsThreads    SmsThread[]

  owner User  @relation("ContactsOwned", fields: [ownerId], references: [id])
  user  User? @relation("ContactsSaved", fields: [userId], references: [id])

  @@unique([ownerId, userId], name: "ownerId_userId")
  @@unique([ownerId, externalPhone], name: "ownerId_externalPhone")
  @@index([ownerId])
  @@index([userId])
}

model Report {
  id               Int      @id @default(autoincrement())
  messageId        Int
  reporterId       Int
  decryptedContent String
  createdAt        DateTime @default(now())

  status     String    @default("OPEN")
  resolvedAt DateTime?
  notes      String?

  message  Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  reporter User    @relation("UserReports", fields: [reporterId], references: [id], onDelete: Cascade)

  @@index([status, createdAt])
}

model AuditLog {
  id      Int  @id @default(autoincrement())
  actorId Int
  actor   User @relation("AuditActor", fields: [actorId], references: [id], onDelete: Cascade)

  action     String
  resource   String?
  resourceId String?
  status     Int
  ip         String?
  userAgent  String?
  metadata   Json?
  createdAt  DateTime @default(now())

  @@index([actorId, createdAt])
  @@index([action, createdAt])
}

model SupportTicket {
  id        Int      @id @default(autoincrement())
  name      String
  email     String
  message   String
  status    String   @default("new") // "new" | "in_progress" | "closed"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AdInquiry {
  id        Int      @id @default(autoincrement())
  name      String
  email     String
  company   String?
  budget    String? // free-text range, e.g. "$1k–$5k"
  message   String
  status    String   @default("new") // new | in_progress | closed
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ===================== 8) Status / Stories =====================

model Status {
  id                Int            @id @default(autoincrement())
  authorId          Int
  captionCiphertext String?
  encryptedKeys     Json?
  translatedFrom    String?
  translations      Json?
  isExplicit        Boolean        @default(false)
  audience          StatusAudience @default(MUTUALS)
  expiresAt         DateTime
  createdAt         DateTime       @default(now())

  author User @relation(fields: [authorId], references: [id], onDelete: Cascade)

  assets    StatusAsset[]
  keys      StatusKey[]
  views     StatusView[]
  reactions StatusReaction[]

  @@index([authorId, expiresAt])
}

model StatusAsset {
  id          Int             @id @default(autoincrement())
  statusId    Int
  kind        StatusAssetKind
  url         String
  mimeType    String
  width       Int?
  height      Int?
  durationSec Int?
  caption     String?
  createdAt   DateTime        @default(now())

  status Status @relation(fields: [statusId], references: [id], onDelete: Cascade)

  @@index([statusId])
}

model StatusKey {
  statusId     Int
  userId       Int
  encryptedKey String

  status Status @relation(fields: [statusId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([statusId, userId])
}

model StatusView {
  id       Int      @id @default(autoincrement())
  statusId Int
  viewerId Int
  viewedAt DateTime @default(now())

  status Status @relation(fields: [statusId], references: [id], onDelete: Cascade)
  viewer User   @relation(fields: [viewerId], references: [id], onDelete: Cascade)

  @@unique([statusId, viewerId])
  @@index([viewerId])
}

model StatusReaction {
  statusId Int
  userId   Int
  emoji    String

  status Status @relation(fields: [statusId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([statusId, userId, emoji])
  @@index([statusId, emoji], map: "status_emoji")
}

// ===================== 9) Bots & Automation =====================

model Bot {
  id      Int  @id @default(autoincrement())
  ownerId Int
  owner   User @relation("BotsOwned", fields: [ownerId], references: [id], onDelete: Cascade)

  name   String
  url    String
  secret String

  serviceUserId Int?
  serviceUser   User? @relation("BotServiceUser", fields: [serviceUserId], references: [id], onDelete: SetNull)

  installs  BotInstall[]
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  @@unique([ownerId, name])
}

model BotInstall {
  id           Int          @id @default(autoincrement())
  botId        Int
  chatRoomId   Int
  contentScope ContentScope @default(COMMANDS)
  isEnabled    Boolean      @default(true)
  scopes       String?

  bot      Bot      @relation(fields: [botId], references: [id], onDelete: Cascade)
  chatRoom ChatRoom @relation("BotInstallRoom", fields: [chatRoomId], references: [id], onDelete: Cascade)

  events    BotEventLog[]
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@unique([botId, chatRoomId])
}

model BotEventLog {
  id            Int       @id @default(autoincrement())
  installId     Int
  eventId       String    @unique @default(cuid())
  type          String
  payload       Json
  status        String    @default("pending")
  attempts      Int       @default(0)
  nextAttemptAt DateTime?
  lastError     String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  install BotInstall @relation(fields: [installId], references: [id], onDelete: Cascade)

  @@index([installId])
}

model ForiaMessage {
  id        Int      @id @default(autoincrement())
  userId    Int
  role      String // 'user' or 'assistant'
  content   String   @db.Text
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
}

// ===================== 10) Telecom: Calls / Numbers / Voicemail / Porting =====================

model Call {
  id       Int        @id @default(autoincrement())
  roomId   Int?
  callerId Int
  calleeId Int
  mode     CallMode
  status   CallStatus @default(RINGING)

  offerSdp  String?
  answerSdp String?
  createdAt DateTime  @default(now())
  startedAt DateTime?
  endedAt   DateTime?

  caller User @relation("CallCaller", fields: [callerId], references: [id])
  callee User @relation("CallCallee", fields: [calleeId], references: [id])

  @@index([callerId])
  @@index([calleeId])
  @@index([roomId])
}

model Phone {
  id         Int       @id @default(autoincrement())
  number     String    @unique
  userId     Int?
  optedOut   Boolean   @default(false)
  optedOutAt DateTime?
  verifiedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // relations
  user                 User?                      @relation(fields: [userId], references: [id])
  verificationRequests PhoneVerificationRequest[]
  messages             SmsMessage[]

  @@index([userId])
}

model PhoneVerificationRequest {
  id                  Int       @id @default(autoincrement())
  phoneNumber         String
  verificationCode    String
  expiresAt           DateTime
  consentedAt         DateTime
  ipAddress           String?
  userAgent           String?
  intent              String?
  verifiedAt          DateTime?
  consumedAt          DateTime? // new: marks token consumed (single-use)
  phoneVerificationId String?   @unique
  createdAt           DateTime  @default(now())

  // optional FK to Phone
  phoneId Int?
  phone   Phone? @relation(fields: [phoneId], references: [id])

  @@index([phoneId])
}

model SmsCarrierEvent {
  id        Int      @id @default(autoincrement())
  from      String
  to        String
  body      String   @db.Text
  direction String // 'inbound' | 'outbound'
  action    String? // 'opt_out' | 'help' | 'verify' | 'notification' | etc.
  metadata  Json?
  createdAt DateTime @default(now())
}

model Subscriber {
  id                Int      @id @default(autoincrement())
  userId            Int?     // optional: unassigned until user claims
  provider          String   // 'oneglobal' | 'telna' | 'plintron' | 'twilio' ...
  providerProfileId String?  // provider's internal profile / resource id
  iccid             String?  @unique
  iccidHint         String?
  smdp              String?  // SMDP (if provided)
  activationCode    String?  // matchingId or activation token (if stored)
  lpaUri            String?  // deep link / LPA for provisioning
  qrPayload         String?  // QR payload or svg
  msisdn            String?  // assigned phone number (E.164) if any
  region            String?  @db.VarChar(8)
  status            String   @default("PENDING") // PENDING | ACTIVE | SUSPENDED | CANCELLED
  providerMeta      Json?    // raw provider response / audit
  createdAt         DateTime @default(now())
  activatedAt       DateTime?
  suspendedAt       DateTime?
  expiresAt         DateTime?
  updatedAt         DateTime @updatedAt

  @@index([userId])
  @@index([provider, providerProfileId])
  @@index([msisdn])
}

model SmsConsent {
  id                 Int      @id @default(autoincrement())
  phone              String
  pendingRegistration Json?    // snapshot of the registration (optional)
  consentTextVersion String
  ipAddress          String? 
  userAgent          String?
  createdAt          DateTime @default(now())

  @@index([phone])
}

model SmsOptOut {
  id               Int      @id @default(autoincrement())
  phone            String   // stored in normalized E.164 form, e.g. +14155551234
  provider         String?  // e.g. "twilio"
  reason           String?  // the incoming text (STOP, HELP, STOPALL, etc.)
  inboundMessageId String?  // provider message SID if available
  rawPayload       Json?    // full webhook payload for audit
  ipAddress        String?  // optional source IP of webhook
  userAgent        String?  // optional UA
  createdAt        DateTime @default(now())

  @@index([phone])
  @@unique([phone, provider])
}

model PhoneOtp {
  id               Int      @id @default(autoincrement())
  phone            String
  otpCode          String
  providerMessageId String?  // optional Twilio SID
  attempts         Int      @default(0)
  expiresAt        DateTime
  createdAt        DateTime @default(now())

  @@index([phone])
}

model PhoneNumber {
  id             Int               @id @default(autoincrement())
  e164           String            @unique
  provider       String            @default("twilio")
  twilioSid      String?
  areaCode       String?
  isoCountry     String?           @db.VarChar(2) // 'US', 'CA', ...
  capabilities   Json?
  vanity         Boolean           @default(false)
  forSale        Boolean           @default(false)
  status         NumberStatus      @default(AVAILABLE)
  assignedUserId Int?
  assignedAt     DateTime?
  lastOutboundAt DateTime?
  keepLocked     Boolean           @default(false)
  holdUntil      DateTime?
  releaseAfter   DateTime?
  portStatus     PortStatus        @default(NONE)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  source         PhoneNumberSource @default(PROVISIONED)

  voicemails Voicemail[] @relation("PhoneNumberVoicemails")

  assignedUser User?               @relation(fields: [assignedUserId], references: [id], onDelete: SetNull)
  reservations NumberReservation[] @relation("PhoneNumberReservations")

  @@index([status])
  @@index([assignedUserId])
  @@index([provider, areaCode, status])
  @@index([isoCountry, status])
  @@index([isoCountry, areaCode, status, forSale])
  @@index([provider, isoCountry, areaCode, status, forSale])
}

model NumberReservation {
  id            Int      @id @default(autoincrement())
  phoneNumberId Int
  userId        Int
  expiresAt     DateTime
  createdAt     DateTime @default(now())

  phone PhoneNumber @relation("PhoneNumberReservations", fields: [phoneNumberId], references: [id])
  user  User        @relation("UserNumberReservations", fields: [userId], references: [id])

  @@index([expiresAt])
}

model PortRequest {
  id     String @id @default(cuid())
  userId Int
  user   User   @relation(fields: [userId], references: [id])

  phoneNumber String

  // Twilio / carrier related IDs
  externalPortId String? // e.g. Twilio port order SID

  carrier       String?
  accountNumber String?
  pin           String?

  fullName     String
  addressLine1 String
  addressLine2 String?
  city         String
  state        String
  postalCode   String
  country      String  @default("US")

  status PortStatus @default(NONE)

  statusReason String?

  scheduledAt DateTime?
  completedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model VoiceLog {
  id          Int      @id @default(autoincrement())
  callSid     String   @unique
  status      String
  from        String?
  to          String?
  direction   String?
  answeredBy  String?
  timestamp   DateTime @default(now())
  durationSec Int?
  rawPayload  Json?
  createdAt   DateTime @default(now())
}

model Voicemail {
  id     String @id @default(cuid())
  userId Int
  user   User   @relation(fields: [userId], references: [id])

  phoneNumberId Int?
  phoneNumber   PhoneNumber? @relation("PhoneNumberVoicemails", fields: [phoneNumberId], references: [id])

  fromNumber String
  toNumber   String

  audioUrl         String
  durationSec      Int?
  transcript       String?
  transcriptStatus VoicemailTranscriptStatus @default(PENDING)

  isRead    Boolean   @default(false)
  deleted   Boolean   @default(false)
  deletedAt DateTime?

  createdAt          DateTime  @default(now())
  forwardedToEmailAt DateTime?
}

// ===================== 11) Accessibility / Usage =====================

model Transcript {
  id        String   @id @default(uuid())
  userId    Int
  callId    String? // if generated during a call
  messageId Int? // if generated from a voice note
  language  String? // e.g., "en-US"
  segments  Json // [{start,end,text}, ...]
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
  @@index([callId])
  @@index([messageId])
}

model STTUsage {
  id        Int      @id @default(autoincrement())
  userId    Int
  monthKey  String // e.g., '2025-08'
  seconds   Int      @default(0) // consumed STT seconds
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  user User @relation("UserSTTUsage", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, monthKey])
  @@index([monthKey])
  @@index([userId, updatedAt])
}
